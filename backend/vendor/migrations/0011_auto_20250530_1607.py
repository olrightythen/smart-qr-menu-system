# Generated by Django 5.0 on 2025-05-30 10:22

from django.db import migrations
import uuid


def link_orders_to_tables(apps, schema_editor):
    """Link existing orders to tables based on QR codes"""
    Order = apps.get_model('vendor', 'Order')
    Table = apps.get_model('vendor', 'Table')

    for order in Order.objects.filter(table__isnull=True, table_identifier__isnull=False):
        try:
            # Try to parse table_identifier as UUID
            qr_uuid = uuid.UUID(order.table_identifier)
            # Find the table with this QR code
            table = Table.objects.filter(qr_code=qr_uuid).first()
            if table:
                order.table = table
                order.save(update_fields=['table'])
                print(f"Linked order {order.id} to table {table.name}")
        except (ValueError, TypeError):
            # table_identifier is not a valid UUID, skip
            print(f"Order {order.id} has non-UUID table_identifier: {order.table_identifier}")
            continue


def reverse_link_orders_to_tables(apps, schema_editor):
    """Reverse the linking (for rollback)"""
    pass


class Migration(migrations.Migration):
    dependencies = [
        ("vendor", "0010_order_table")
    ]

    operations = [
        migrations.RunPython(link_orders_to_tables, reverse_link_orders_to_tables),
    ]
